<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Budget Pro – บัญชีรายรับรายจ่าย</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#11151a; --muted:#8b98a5; --text:#e9eef5; --accent:#4a8bff; --accent-2:#7bde8a; --danger:#ff6b6b; --warn:#ffb020; --ok:#42d392; --border:#1c232b;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .light{
    --bg:#f6f8fb; --panel:#ffffff; --muted:#5a6672; --text:#0f1720; --accent:#1967d2; --accent-2:#2ea36a; --danger:#c53b3b; --warn:#b8860b; --ok:#1b8e5a; --border:#e7eef5;
    --shadow:0 10px 30px rgba(16,24,40,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Inter,Roboto,"Helvetica Neue",Arial}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(0,0,0,0)), var(--bg);backdrop-filter:saturate(1.2) blur(6px)}
  .bar{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border)}
  .title{font-weight:700;letter-spacing:.3px}
  .grow{flex:1}
  button,select,input,textarea{color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  select,input[type="date"]{padding:9px 10px}
  button{cursor:pointer;transition:.15s transform}
  button:active{transform:translateY(1px)}
  .accent{background:var(--accent);border-color:transparent;color:#fff}
  .danger{background:var(--danger);border-color:transparent;color:#fff}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:10px 18px;border-bottom:1px solid var(--border)}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  main{max-width:1100px;margin:24px auto;padding:0 16px 60px}
  .grid{display:grid;gap:16px}
  @media(min-width:920px){.grid.cols-3{grid-template-columns:2fr 1fr 1fr}}
  @media(min-width:920px){.grid.cols-2{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 10px 0;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1}
  .kpi{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;border:1px dashed var(--border)}
  .kpi strong{font-size:18px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  tr:hover td{background:rgba(127,127,127,.05)}
  .badge{display:inline-block;padding:6px 9px;border-radius:999px;border:1px solid var(--border);font-size:12px}
  .progress{height:10px;background:#00000010;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .right{text-align:right}
  .pill{padding:7px 10px;border-radius:999px;border:1px solid var(--border)}
  .note{font-size:12px;color:var(--muted)}
  .hidden{display:none !important}

  /* Auth */
  .auth-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:9999}
  .auth-card{width:min(520px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
  .auth-head{display:flex;gap:8px;margin-bottom:12px}
  .auth-tab{flex:1;text-align:center;padding:12px;border-radius:12px;border:1px solid var(--border);cursor:pointer;font-weight:600}
  .auth-tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .auth-group{display:flex;flex-direction:column;gap:8px}
  .auth-actions{display:flex;gap:8px;margin-top:6px}
  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:10000}
  .ok{color:#42d392}.err{color:#ff6b6b}
</style>
</head>
<body class="light" id="body">

  <!-- AUTH OVERLAY -->
  <div id="auth" class="auth-backdrop hidden" aria-hidden="true">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-tab active" data-mode="login">ล็อกอิน</div>
        <div class="auth-tab" data-mode="signup">สมัครสมาชิก</div>
      </div>
      <div class="auth-group">
        <input id="authUser" placeholder="ชื่อผู้ใช้ (a-z0-9_)" autocomplete="username">
        <input id="authPass" type="password" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัว)" autocomplete="current-password">
        <div class="auth-actions">
          <button id="authSubmit" class="accent" style="flex:1">เข้าสู่ระบบ</button>
          <button id="authGuest" class="pill" style="flex:1">Guest</button>
        </div>
        <div id="authMsg" class="note"></div>
      </div>
    </div>
  </div>

  <header>
    <div class="bar">
      <div class="title">Budget Pro</div>
      <div class="grow"></div>
      <div id="currentUser" class="pill hidden"></div>
      <label class="pill"><input type="month" id="monthPicker" style="border:0;background:transparent;padding:6px 8px"> เดือน</label>
      <button id="addDemo" class="pill">เติมข้อมูลตัวอย่าง</button>
      <button id="theme" class="pill">โหมดมืด/สว่าง</button>
      <button id="logout" class="pill danger hidden">ออกจากระบบ</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="transactions">รายการ</div>
      <div class="tab" data-tab="categories">หมวดหมู่ & งบ</div>
      <div class="tab" data-tab="goals">เป้าหมาย</div>
      <div class="tab" data-tab="analysis">วิเคราะห์</div>
      <div class="tab" data-tab="settings">ตั้งค่า / นำเข้า–ส่งออก</div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="grid cols-3">
      <div class="card">
        <h3>สรุปเดือนนี้</h3>
        <div class="grid cols-2">
          <div class="kpi"><div>รายรับ</div><strong id="kpiIncome">–</strong></div>
          <div class="kpi"><div>รายจ่าย</div><strong id="kpiExpense">–</strong></div>
        </div>
        <div class="kpi" style="margin-top:10px"><div>คงเหลือ</div><strong id="kpiBalance">–</strong></div>
        <div class="note" id="smartAlert" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>สัดส่วนรายจ่ายตามหมวด</h3>
        <svg id="pie" style="height:240px;width:100%"></svg>
      </div>

      <div class="card">
        <h3>แนวโน้มรายวัน</h3>
        <svg id="bars" style="height:240px;width:100%"></svg>
      </div>
    </section>

    <!-- TRANSACTIONS (one-shot: income & expense together) -->
    <section id="transactions" class="hidden">
      <div class="card">
        <h3>บันทึกรายการ (ครั้งเดียวใส่ได้ทั้งรับ/จ่าย)</h3>
        <div class="row">
          <input type="date" id="dDate">
          <input type="number" id="dIncome" placeholder="รายรับ (บาท)">
          <select id="dIncomeCat"><option>อื่นๆ</option></select>
          <input type="number" id="dExpense" placeholder="รายจ่าย (บาท)">
          <select id="dExpenseCat"><option>อาหาร</option></select>
          <input id="dNote" placeholder="บันทึกย่อ (ไม่บังคับ)">
        </div>
        <div class="row" style="margin-top:8px">
          <label class="pill" style="flex:0 0 auto"><input type="checkbox" id="dRecurring"> ทำเป็นรายการประจำ</label>
          <div class="grow"></div>
          <button id="saveDay" class="accent">+ บันทึกวันนี้</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <input id="search" placeholder="ค้นหา...">
          <select id="filterType"><option value="">ทุกประเภท</option><option value="income">เฉพาะรายรับ</option><option value="expense">เฉพาะรายจ่าย</option></select>
          <select id="filterCat"></select>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table id="txTable">
            <thead><tr><th>วันที่</th><th>ประเภท</th><th>หมวด</th><th class="right">จำนวน</th><th>บันทึก</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CATEGORIES -->
    <section id="categories" class="hidden">
      <div class="card">
        <h3>หมวดหมู่ & งบประมาณ</h3>
        <div class="row">
          <input id="newCat" placeholder="เพิ่มหมวดหมู่ใหม่ เช่น อาหาร">
          <input id="newBudget" type="number" placeholder="งบต่อเดือน (บาท)">
          <button id="addCat" class="accent">+ เพิ่มหมวด</button>
        </div>
        <div class="grid cols-2" id="catList" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- GOALS (target + due, show required/day) -->
    <section id="goals" class="hidden">
      <div class="card">
        <h3>เป้าหมายการเงิน</h3>
        <div class="row">
          <input id="goalName" placeholder="ชื่อเป้าหมาย เช่น เงินสำรองฉุกเฉิน">
          <input id="goalTarget" type="number" placeholder="จำนวนเป้าหมาย (บาท)">
          <input id="goalDue" type="date" placeholder="กำหนดเสร็จ">
          <button id="addGoal" class="accent">+ สร้างเป้าหมาย</button>
        </div>
        <div class="note">ระบบจะแนะนำ “ต้องออมต่อวัน” จากวันนี้ถึงวันกำหนดเสร็จ</div>
      </div>
      <div id="goalList" class="grid cols-2"></div>
    </section>

    <!-- ANALYSIS -->
    <section id="analysis" class="hidden">
      <div class="grid cols-2">
        <div class="card">
          <h3>สรุปเดือน (อิงวันที่บันทึกจริง)</h3>
          <div class="grid cols-2">
            <div class="kpi"><div>วันสุดท้ายที่บันทึก</div><strong id="kpiLastDay">–</strong></div>
            <div class="kpi"><div>วันคงเหลือ</div><strong id="kpiRemainDays">–</strong></div>
          </div>
          <div class="grid cols-2" style="margin-top:8px">
            <div class="kpi"><div>เฉลี่ยรายจ่าย/วัน (จนถึงวันล่าสุด)</div><strong id="kpiBurn">–</strong></div>
            <div class="kpi"><div>คาดการณ์รายจ่ายสิ้นเดือน</div><strong id="kpiForecast">–</strong></div>
          </div>
        </div>
        <div class="card">
          <h3>Top หมวดรายจ่าย (เดือนที่เลือก)</h3>
          <div id="topCats" class="row"></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>รายรับ/รายจ่ายย้อนหลัง 12 เดือน</h3>
        <svg id="hist12" style="height:260px;width:100%"></svg>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="hidden">
      <div class="card">
        <h3>สำรองข้อมูล</h3>
        <div class="row">
          <button id="exportJson">ส่งออก JSON</button>
          <button id="exportCsv">ส่งออก CSV</button>
          <input type="file" id="importFile" accept=".json">
          <button id="importJson" class="accent">นำเข้า JSON</button>
          <button id="resetAll" class="danger">ล้างข้อมูลทั้งหมดของผู้ใช้ปัจจุบัน</button>
        </div>
        <div class="note">ข้อมูลถูกเก็บแบบออฟไลน์ในเบราว์เซอร์ของคุณ (localStorage)</div>
      </div>
    </section>
  </main>

<script>
/* ---------- Tiny helpers ---------- */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>(n||0).toLocaleString('th-TH',{maximumFractionDigits:0});
const today=()=>new Date().toISOString().slice(0,10);
const ym=d=>d.slice(0,7);
const sum=a=>a.reduce((x,y)=>x+y,0);
const byMonth=(arr,month)=>arr.filter(t=>ym(t.date)===month);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function toast(txt,cls='ok'){const t=document.createElement('div');t.className='toast '+cls;t.textContent=txt;document.body.appendChild(t);setTimeout(()=>t.remove(),1600);}

/* ---------- UUID & crypto fallbacks ---------- */
function uid(){
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  const rnd=(len)=>{ if(window.crypto?.getRandomValues){const a=new Uint8Array(len);crypto.getRandomValues(a);return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('')}
    let s='',c='abcdef0123456789';for(let i=0;i<len*2;i++) s+=c[Math.floor(Math.random()*c.length)];return s;}
  return `${rnd(4)}-${rnd(2)}-${rnd(2)}-${rnd(2)}-${rnd(6)}`
}
const b64=b=>btoa(String.fromCharCode(...new Uint8Array(b)));
async function sha256(s){ if(window.crypto?.subtle?.digest){const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));return b64(b)} let h=0;for(let i=0;i<s.length;i++){h=(h<<5)-h+s.charCodeAt(i);h|=0}return String(h)}
function randomSalt(len=16){ if(window.crypto?.getRandomValues){const a=new Uint8Array(len);crypto.getRandomValues(a);return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('')} let s='',c='abcdef0123456789';for(let i=0;i<len*2;i++) s+=c[Math.floor(Math.random()*c.length)];return s }

/* ---------- Storage ---------- */
const GLOBAL={usersKey:'bp_users',sessionKey:'bp_session'};
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const getUsers=()=>load(GLOBAL.usersKey,{}); const setUsers=o=>save(GLOBAL.usersKey,o);
const userKeys=u=>({tx:`bp:${u}:tx`,cats:`bp:${u}:cats`,goals:`bp:${u}:goals`,settings:`bp:${u}:settings`});

/* ---------- Auth ---------- */
async function signUp(u,p){const users=getUsers(); if(users[u])throw new Error('มีผู้ใช้นี้อยู่แล้ว'); if(!/^[a-z0-9_]{3,20}$/.test(u))throw new Error('ชื่อผู้ใช้ a-z0-9_ 3–20 ตัว'); if((p||'').length<6)throw new Error('รหัสผ่านอย่างน้อย 6 ตัว'); const salt=randomSalt(), hash=await sha256(p+salt); users[u]={salt,hash}; setUsers(users); save(GLOBAL.sessionKey,{u});}
async function login(u,p){const rec=getUsers()[u]; if(!rec)throw new Error('ไม่พบบัญชีนี้'); const h=await sha256(p+rec.salt); if(h!==rec.hash)throw new Error('รหัสผ่านไม่ถูกต้อง'); save(GLOBAL.sessionKey,{u});}
function session(){return load(GLOBAL.sessionKey,null)?.u||null}
function logout(){localStorage.removeItem(GLOBAL.sessionKey); location.reload()}

/* ---------- State ---------- */
const DefaultCats=[{name:'อาหาร',budget:4000},{name:'เดินทาง',budget:1500},{name:'บิลรายเดือน',budget:3000},{name:'บันเทิง',budget:1000},{name:'อื่นๆ',budget:0}];
let CUR=session()||null; let LS=CUR?userKeys(CUR):userKeys('guest'); let S=null;

function initUser(){
  const cats=load(LS.cats,null);
  S={ tx:load(LS.tx,[]), cats:cats??DefaultCats.slice(), goals:load(LS.goals,[]), settings:load(LS.settings,{theme:'light'}) };
  if(!cats) saveAll();
}
function saveAll(){ save(LS.tx,S.tx); save(LS.cats,S.cats); save(LS.goals,S.goals); save(LS.settings,S.settings); }
function swapUser(u){ CUR=u; LS=userKeys(u); initUser(); $('#currentUser').classList.remove('hidden'); $('#currentUser').textContent='@'+u; $('#logout').classList.remove('hidden'); renderAll();}

function showAuth(){const a=$('#auth');a.classList.remove('hidden');a.style.display='flex'}
function hideAuth(){const a=$('#auth');a.classList.add('hidden');a.style.display='none';requestAnimationFrame(()=>{try{a.parentNode&&a.parentNode.removeChild(a)}catch{}})}
let authMode='login';
$('#authGuest').onclick=()=>{save(GLOBAL.sessionKey,{u:'guest'}); hideAuth(); swapUser('guest'); toast('Guest mode','ok')}
$$('.auth-tab').forEach(t=>t.onclick=()=>{ $$('.auth-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); authMode=t.dataset.mode; $('#authSubmit').textContent=authMode==='login'?'เข้าสู่ระบบ':'สมัครสมาชิก'; $('#authMsg').textContent='' });
$('#authSubmit').onclick=async()=>{ $('#authMsg').textContent=''; try{ const u=$('#authUser').value.trim(), p=$('#authPass').value; if(authMode==='signup'){await signUp(u,p); toast('สมัครสำเร็จ','ok')} else {await login(u,p); toast('เข้าสู่ระบบสำเร็จ','ok')} hideAuth(); swapUser(u);}catch(e){ $('#authMsg').innerHTML='<span class="err">• '+(e.message||'ผิดพลาด')+'</span>' }}

/* ---------- UI init ---------- */
const mp=$('#monthPicker'); const nowYM=new Date().toISOString().slice(0,7);
function initMonth(){ const key=`bp:${CUR||'guest'}:month`; mp.value=load(key,nowYM); mp.onchange=()=>{save(key,mp.value); renderAll()} }
$('#theme').onclick=()=>{ const b=$('body'); if(b.classList.contains('light')){b.classList.remove('light');S.settings.theme='dark'}else{b.classList.add('light');S.settings.theme='light'} save(LS.settings,S.settings); }
$$('.tab').forEach(t=>t.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); ['dashboard','transactions','categories','goals','analysis','settings'].forEach(id=>$('#'+id).classList.toggle('hidden', id!==t.dataset.tab)); renderAll(); });

/* ---------- Categories ---------- */
function fillCategorySelects(){
  const opts=S.cats.map(c=>`<option>${c.name}</option>`).join('');
  $('#dIncomeCat').innerHTML=`<option>อื่นๆ</option>`; // รายรับไม่ผูกงบ
  $('#dExpenseCat').innerHTML=opts;
  $('#filterCat').innerHTML=`<option value="">ทุกหมวด</option>`+opts;
}
$('#addCat').onclick=()=>{ const name=$('#newCat').value.trim(); if(!name) return; const budget=+($('#newBudget').value||0); if(S.cats.find(c=>c.name===name)){alert('มีหมวดนี้แล้ว');return} S.cats.push({name,budget}); saveAll(); $('#newCat').value=''; $('#newBudget').value=''; fillCategorySelects(); renderCats(); renderAll(); };
function renderCats(){
  const wrap=$('#catList'); wrap.innerHTML='';
  const month=mp.value; const txm=byMonth(S.tx,month).filter(t=>t.type==='expense');
  S.cats.forEach(c=>{ const spent=sum(txm.filter(t=>t.category===c.name).map(t=>t.amount)); const pct=c.budget?clamp(spent/c.budget*100,0,100):0;
    const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div style="font-weight:700">${c.name}</div>
      <div class="progress" style="margin:8px 0 6px"><i style="width:${pct}%"></i></div>
      <div class="row"><div>ใช้ไป ${fmt(spent)} / ${c.budget?fmt(c.budget):'–'} บาท</div>
      <div style="text-align:right"><input type="number" class="catB" data-cat="${c.name}" value="${c.budget||0}" style="width:140px"></div></div>`;
    wrap.appendChild(d);
  });
  $$('.catB').forEach(i=>i.onchange=()=>{ const c=S.cats.find(x=>x.name===i.dataset.cat); c.budget=+i.value||0; saveAll(); renderCats(); renderAll(); });
}

/* ---------- Transactions (one-shot) ---------- */
$('#dDate').value=today();
$('#saveDay').onclick=()=>{ const date=$('#dDate').value||today(); const inc=+($('#dIncome').value||0), exp=+($('#dExpense').value||0), note=$('#dNote').value.trim(), rec=$('#dRecurring').checked;
  const add=[]; if(inc>0) add.push({id:uid(),date,type:'income',amount:inc,category:$('#dIncomeCat').value||'อื่นๆ',note,recurring:rec});
  if(exp>0) add.push({id:uid(),date,type:'expense',amount:exp,category:$('#dExpenseCat').value, note,recurring:rec});
  if(!add.length){alert('กรอกอย่างน้อย 1 ช่อง: รายรับ หรือ รายจ่าย'); return}
  S.tx.push(...add); saveAll(); $('#dIncome').value=''; $('#dExpense').value=''; $('#dNote').value=''; $('#dRecurring').checked=false; renderAll(); toast('บันทึกแล้ว','ok');
};
function applyRecurring(month){
  const y=+month.slice(0,4), m=+month.slice(5,7), first=`${y}-${String(m).padStart(2,'0')}-01`;
  const exKeys=new Set(byMonth(S.tx,month).map(t=>[t.type,t.category,t.amount,t.note].join('|')));
  S.tx.filter(t=>t.recurring).forEach(t=>{ const k=[t.type,t.category,t.amount,t.note].join('|'); if(!exKeys.has(k)) S.tx.push({...t,id:uid(),date:first}) });
  saveAll();
}
function renderTable(){
  const month=mp.value; applyRecurring(month);
  const tb=$('#txTable tbody'); tb.innerHTML='';
  let rows=byMonth(S.tx,month);
  const q=($('#search').value||'').toLowerCase(), ftype=$('#filterType').value||'', fcat=$('#filterCat').value||'';
  if(q) rows=rows.filter(t=>((t.note||'')+' '+t.category).toLowerCase().includes(q));
  if(ftype) rows=rows.filter(t=>t.type===ftype); if(fcat) rows=rows.filter(t=>t.category===fcat);
  rows.sort((a,b)=>a.date.localeCompare(b.date));
  rows.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.date}</td>
    <td><span class="badge" style="border-color:${t.type==='income'?'var(--ok)':'var(--danger)'};color:${t.type==='income'?'var(--ok)':'var(--danger)'}">${t.type==='income'?'รับ':'จ่าย'}</span></td>
    <td>${t.category}</td><td class="right">${fmt(t.amount)}</td><td>${t.note||''}${t.recurring? ' <span class="badge">ประจำ</span>':''}</td>
    <td class="right"><button class="pill" data-id="${t.id}">ลบ</button></td>`; tb.appendChild(tr); });
  $$('#txTable tbody button').forEach(b=>b.onclick=()=>{ S.tx=S.tx.filter(x=>x.id!==b.dataset.id); saveAll(); renderAll(); });
}
$('#search').oninput=renderTable; $('#filterType').onchange=renderTable; $('#filterCat').onchange=renderTable;

/* ---------- Goals (fixed + required/day) ---------- */
$('#addGoal').onclick=()=>{ const name=$('#goalName').value.trim(), target=+($('#goalTarget').value||0), due=$('#goalDue').value;
  if(!name||!target||!due){ alert('กรอกชื่อ, จำนวนเป้าหมาย และกำหนดเสร็จ'); return }
  S.goals.push({id:uid(),name,target,saved:0,due}); saveAll(); $('#goalName').value=''; $('#goalTarget').value=''; $('#goalDue').value=''; renderGoals(); toast('สร้างเป้าหมายแล้ว','ok');
};
function daysBetween(a,b){ return Math.ceil((b-a)/(1000*60*60*24)) }
function renderGoals(){
  const wrap=$('#goalList'); wrap.innerHTML='';
  const todayDate=new Date(today());
  S.goals.forEach(g=>{
    const due=new Date(g.due||today()); const remain=Math.max(0, daysBetween(todayDate, due));
    const need=Math.max(0, g.target - g.saved);
    const perDay = remain>0 ? Math.ceil(need/remain) : need;
    const pct = g.target? clamp(g.saved/g.target*100,0,100) : 0;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>${g.name}</h3>
      <div class="progress"><i style="width:${pct}%"></i></div>
      <div class="row" style="margin-top:8px">
        <div class="kpi"><div>สะสม</div><strong>${fmt(g.saved)}</strong></div>
        <div class="kpi"><div>เป้าหมาย</div><strong>${fmt(g.target)}</strong></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="kpi"><div>กำหนดเสร็จ</div><strong>${g.due||'—'}</strong></div>
        <div class="kpi"><div>ต้องออมต่อวัน</div><strong>${fmt(perDay)}</strong></div>
      </div>
      <div class="row" style="margin-top:10px">
        <input type="number" placeholder="เพิ่มเงิน (บาท)" id="g_${g.id}">
        <button class="accent" data-add="${g.id}">+ เพิ่ม</button>
        <button class="danger" data-del="${g.id}">ลบ</button>
      </div>`;
    wrap.appendChild(card);
  });
  $$('#goalList [data-add]').forEach(b=>b.onclick=()=>{ const id=b.dataset.add; const v=+($('#g_'+id).value||0); const g=S.goals.find(x=>x.id===id); g.saved+=Math.max(0,v); saveAll(); renderGoals(); });
  $$('#goalList [data-del]').forEach(b=>b.onclick=()=>{ const id=b.dataset.del; S.goals=S.goals.filter(x=>x.id!==id); saveAll(); renderGoals(); });
}

/* ---------- Dashboard ---------- */
function renderKPIs(){
  const month=mp.value; const txm=byMonth(S.tx,month);
  const inc=sum(txm.filter(t=>t.type==='income').map(t=>t.amount));
  const exp=sum(txm.filter(t=>t.type==='expense').map(t=>t.amount));
  $('#kpiIncome').textContent=fmt(inc); $('#kpiExpense').textContent=fmt(exp); $('#kpiBalance').textContent=fmt(inc-exp);
}

/* ---------- Charts ---------- */
function renderPie(){
  const svg=$('#pie'); svg.innerHTML='';
  const month=mp.value; const exp=byMonth(S.tx,month).filter(t=>t.type==='expense'); const total=sum(exp.map(t=>t.amount));
  if(!total){ svg.innerHTML='<text x="50%" y="50%" text-anchor="middle" fill="currentColor" opacity=".5">ไม่มีข้อมูล</text>'; return }
  const w=svg.clientWidth||360, cx=100,cy=120,r=90; const byCat={}; exp.forEach(t=>byCat[t.category]=(byCat[t.category]||0)+t.amount);
  let start=0,i=0; for(const [cat,val] of Object.entries(byCat)){ const frac=val/total; const end=start+frac*2*Math.PI; const x1=cx+r*Math.cos(start),y1=cy+r*Math.sin(start),x2=cx+r*Math.cos(end),y2=cy+r*Math.sin(end),large=frac>0.5?1:0;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`); p.setAttribute('fill',`hsl(${(i*57)%360} 70% 55%)`); p.setAttribute('opacity','0.9'); svg.appendChild(p); start=end; i++; }
  let y=10,idx=0; for(const [cat,val] of Object.entries(byCat).sort((a,b)=>b[1]-a[1])){ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); const color=`hsl(${(idx*57)%360} 70% 55%)`;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',220); rect.setAttribute('y',y); rect.setAttribute('width',14); rect.setAttribute('height',14); rect.setAttribute('fill',color);
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',240); tx.setAttribute('y',y+12); tx.setAttribute('fill','currentColor'); tx.textContent=`${cat} • ${Math.round(val/total*100)}%`;
    g.appendChild(rect); g.appendChild(tx); svg.appendChild(g); y+=18; idx++; }
}
function renderBars(){
  const svg=$('#bars'); svg.innerHTML='';
  const month=mp.value, txm=byMonth(S.tx,month); const [Y,M]=month.split('-').map(Number); const days=new Date(Y,M,0).getDate();
  if(!txm.length){ svg.innerHTML='<text x="50%" y="50%" text-anchor="middle" fill="currentColor" opacity=".5">ไม่มีข้อมูล</text>'; return }
  const byDay=Array.from({length:days},(_,i)=>({d:i+1,inc:0,exp:0}));
  txm.forEach(t=>{ const d=+t.date.slice(8,10)-1; if(t.type==='income') byDay[d].inc+=t.amount; else byDay[d].exp+=t.amount; });
  const h=240,w=svg.clientWidth||600,p=24,barW=(w-p*2)/days; const max=Math.max(1,...byDay.map(x=>x.inc+x.exp));
  byDay.forEach((x,i)=>{ const gx=document.createElementNS('http://www.w3.org/2000/svg','g'); const rx=p+i*barW;
    const eH=Math.round((x.exp/max)*(h-p*2)), iH=Math.round((x.inc/max)*(h-p*2));
    const re=document.createElementNS('http://www.w3.org/2000/svg','rect'); re.setAttribute('x',rx); re.setAttribute('y',h-p-eH); re.setAttribute('width',Math.max(1,barW*0.8)); re.setAttribute('height',eH); re.setAttribute('fill','var(--danger)'); re.setAttribute('opacity','.7');
    const ri=document.createElementNS('http://www.w3.org/2000/svg','rect'); ri.setAttribute('x',rx); ri.setAttribute('y',h-p-eH-iH); ri.setAttribute('width',Math.max(1,barW*0.8)); ri.setAttribute('height',iH); ri.setAttribute('fill','var(--ok)'); ri.setAttribute('opacity','.7');
    gx.appendChild(re); gx.appendChild(ri); svg.appendChild(gx);
  });
  const axis=document.createElementNS('http://www.w3.org/2000/svg','line'); axis.setAttribute('x1',p); axis.setAttribute('x2',w-p); axis.setAttribute('y1',h-p); axis.setAttribute('y2',h-p); axis.setAttribute('stroke','currentColor'); axis.setAttribute('opacity','.3'); svg.appendChild(axis);
}

/* ---------- Analysis (daily-aware) ---------- */
function renderAnalysis(){
  const month=mp.value; const txm=byMonth(S.tx,month); const [Y,M]=month.split('-').map(Number); const daysInMonth=new Date(Y,M,0).getDate();
  const daysRecorded = txm.length ? Math.max(...txm.map(t=>+t.date.slice(8,10))) : 0;
  const remainingDays = Math.max(0, daysInMonth - daysRecorded);
  const inc=sum(txm.filter(t=>t.type==='income').map(t=>t.amount));
  const exp=sum(txm.filter(t=>t.type==='expense').map(t=>t.amount));
  const burn = daysRecorded ? exp/daysRecorded : 0;
  const forecast = Math.round(burn * daysInMonth);

  $('#kpiLastDay').textContent = daysRecorded? String(daysRecorded):'–';
  $('#kpiRemainDays').textContent = String(remainingDays);
  $('#kpiBurn').textContent = fmt(Math.round(burn));
  $('#kpiForecast').textContent = fmt(forecast);

  // top cats
  const byCat={}; txm.filter(t=>t.type==='expense').forEach(t=>byCat[t.category]=(byCat[t.category]||0)+t.amount);
  const top=Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const wrap=$('#topCats'); wrap.innerHTML='';
  top.forEach(([cat,val])=>{ const div=document.createElement('div'); div.className='kpi'; div.innerHTML=`<div>${cat}</div><strong>${fmt(val)}</strong>`; wrap.appendChild(div); });

  // history 12m
  renderHist12();
}
function renderHist12(){
  const svg=$('#hist12'); svg.innerHTML='';
  const base=new Date(mp.value+'-01'); const months=[];
  for(let i=11;i>=0;i--){ const d=new Date(base.getFullYear(), base.getMonth()-i, 1); months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); }
  const data=months.map(m=>({m,inc:sum(byMonth(S.tx,m).filter(t=>t.type==='income').map(t=>t.amount)),exp:sum(byMonth(S.tx,m).filter(t=>t.type==='expense').map(t=>t.amount))}));
  const w=svg.clientWidth||600,h=260,p=30,bar=(w-p*2)/(months.length*2+months.length*0.5),max=Math.max(1,...data.flatMap(x=>[x.inc,x.exp]));
  const avgExp=sum(data.map(d=>d.exp))/data.length, yAvg=h-p-(avgExp/max)*(h-p*2);
  const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',p); line.setAttribute('x2',w-p); line.setAttribute('y1',yAvg); line.setAttribute('y2',yAvg); line.setAttribute('stroke','currentColor'); line.setAttribute('opacity','.25'); svg.appendChild(line);
  data.forEach((d,i)=>{ const x=p+i*(bar*2+bar*0.5); const hi=Math.max(1,Math.round((d.inc/max)*(h-p*2))), he=Math.max(1,Math.round((d.exp/max)*(h-p*2)));
    const ri=document.createElementNS('http://www.w3.org/2000/svg','rect'); ri.setAttribute('x',x); ri.setAttribute('y',h-p-hi); ri.setAttribute('width',bar); ri.setAttribute('height',hi); ri.setAttribute('fill','var(--ok)'); ri.setAttribute('opacity','.75');
    const re=document.createElementNS('http://www.w3.org/2000/svg','rect'); re.setAttribute('x',x+bar+2); re.setAttribute('y',h-p-he); re.setAttribute('width',bar); re.setAttribute('height',he); re.setAttribute('fill','var(--danger)'); re.setAttribute('opacity','.75');
    svg.appendChild(ri); svg.appendChild(re);
  });
}

/* ---------- Export/Import ---------- */
$('#exportJson').onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({user:CUR,S})],{type:'application/json'})); a.download=`budgetpro_${CUR}.json`; a.click(); };
$('#exportCsv').onclick=()=>{ const rows=[['date','type','category','amount','note','recurring']].concat(S.tx.map(t=>[t.date,t.type,t.category,t.amount,t.note||'',t.recurring?'1':'0'])); const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`transactions_${CUR}.csv`; a.click(); };
$('#importJson').onclick=()=>{ const f=$('#importFile').files?.[0]; if(!f){alert('เลือกไฟล์ JSON');return} const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.S){ S=obj.S; saveAll(); renderAll(); toast('นำเข้าสำเร็จ','ok') } else alert('ไฟล์ไม่ถูกต้อง') }catch{ alert('อ่านไฟล์ไม่สำเร็จ') } }; r.readAsText(f); };
$('#resetAll').onclick=()=>{ if(!confirm('ล้างข้อมูลทั้งหมดของผู้ใช้ปัจจุบัน?')) return; save(LS.tx,[]); save(LS.cats,DefaultCats.slice()); save(LS.goals,[]); save(LS.settings,{theme:'light'}); initUser(); renderAll(); };

/* ---------- Render orchestrator ---------- */
function renderAll(){ if(!CUR) return; $('body').classList.toggle('light', S.settings.theme!=='dark'); fillCategorySelects(); renderKPIs(); renderPie(); renderBars(); renderTable(); renderCats(); renderGoals(); renderAnalysis(); }

/* ---------- Boot ---------- */
(function(){
  const u=session(); if(!u){ showAuth(); CUR=null; LS=userKeys('guest'); } else { hideAuth(); swapUser(u); }
  initMonth(); initUser(); renderAll();
  $('#logout').onclick=logout;
})();
</script>
</body>
</html>
